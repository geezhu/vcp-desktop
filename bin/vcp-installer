#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"
VERSION="0.0.0-dev"

for version_path in \
  "${ROOT_DIR}/VERSION" \
  "${SCRIPT_DIR}/../share/vcp-installer/VERSION"; do
  if [ -f "${version_path}" ]; then
    VERSION="$(tr -d '[:space:]' < "${version_path}")"
    break
  fi
done

MODE="auto"
HEADLESS=0
DRY_RUN=0
AUTO_APPROVE=0
SIMULATE_GUI_STEP=0
NO_START_AFTER_INIT=0
STARTUP_DELAY="2"
START_AFTER_INSTALL=0
SKIP_NODE_INSTALL=0
SKIP_PYTHON_INSTALL=0
INSTALL_PLUGIN_PYTHON_DEPS=0
STRICT_DEPENDENCIES=0
FORCE_CONFIG_REWRITE=0
INSTALL_COMPONENTS_ARG="all"

VCP_API_URL_ARG="${VCP_API_URL:-}"
VCP_API_KEY_ARG="${VCP_API_KEY:-}"
VCP_PORT_ARG="${VCP_PORT:-}"
VCP_KEY_ARG="${VCP_KEY:-}"
ADMIN_USER_ARG="${VCP_ADMIN_USER:-}"
ADMIN_PASSWORD_ARG="${VCP_ADMIN_PASSWORD:-}"
CHAT_SERVER_URL_ARG="${VCP_CHAT_SERVER_URL:-}"
CHAT_API_KEY_ARG="${VCP_CHAT_API_KEY:-}"
CHAT_LOG_URL_ARG="${VCP_CHAT_LOG_URL:-}"
CHAT_LOG_KEY_ARG="${VCP_CHAT_LOG_KEY:-}"

WORKSPACE_ROOT_ARG=""
BACKEND_CWD_ARG=""
BACKEND_CMD_ARG=""
CHAT_CWD_ARG=""
CHAT_CMD_ARG=""

WORKSPACE_ROOT_VAL=""
BACKEND_CWD_VAL=""
BACKEND_CMD_VAL=""
CHAT_CWD_VAL=""
CHAT_CMD_VAL=""

COMMAND="auto"
SESSION_ID=""
SESSION_FILE=""
REPORT_DIR=""
INSTALL_REPORT_JSON=""
INSTALL_REPORT_MD=""

INSTALL_STATUS="success"
INSTALL_WARNINGS=()
INSTALL_ERRORS=()
INSTALL_STEPS=()
INSTALL_TOOLBOX_ENABLED=1
INSTALL_CHAT_ENABLED=1

resolve_installer_home() {
  if [ -n "${VCP_INSTALLER_HOME:-}" ]; then
    printf '%s\n' "${VCP_INSTALLER_HOME}"
    return
  fi

  if [ -n "${XDG_DATA_HOME:-}" ]; then
    printf '%s/vcpinstallergui\n' "${XDG_DATA_HOME}"
    return
  fi

  if [ -n "${HOME:-}" ]; then
    printf '%s/.local/share/vcpinstallergui\n' "${HOME}"
    return
  fi

  printf '%s/.vcpinstallergui\n' "${ROOT_DIR}"
}

INSTALLER_HOME="$(resolve_installer_home)"
STATE_DIR="${VCP_INSTALLER_STATE_DIR:-${INSTALLER_HOME}/state}"
CONFIG_FILE="${INSTALLER_HOME}/launcher-config.env"
RUN_DIR="${INSTALLER_HOME}/run"
LOG_DIR="${INSTALLER_HOME}/logs"

mkdir -p "${INSTALLER_HOME}" "${STATE_DIR}" "${RUN_DIR}" "${LOG_DIR}"

timestamp() {
  date -u +"%Y-%m-%dT%H:%M:%SZ"
}

log() {
  local level="$1"
  shift
  printf '%s [%s] %s\n' "$(timestamp)" "${level}" "$*"
}

usage() {
  cat <<'EOF'
VCPInstallerGUI installer

Usage:
  vcp-installer [command] [options]

Commands:
  init                    Run initialization wizard and save launch config
  start                   Start backend and VCPChat with saved config
  stop                    Stop backend and VCPChat started by installer
  status                  Show launcher and process status
  reset                   Remove saved launcher config and runtime state
  install                 Run component install/configuration flow
  resume                  Resume previous install session (state-based)

Options:
  --cli                   Force CLI mode
  --gui                   Force GUI mode
  --auto                  Auto detect mode (default)
  --headless              Headless mode (CLI only)
  --dry-run               Do not run mutation steps
  --yes                   Non-interactive mode
  --simulate-gui-step     Simulate a GUI required step (for testing)
  --no-start-after-init   Initialize only, do not auto-start services
  --workspace-root <dir>  Workspace root path (for init)
  --components <value>    Install targets: all|toolbox|chat|toolbox,chat
  --skip-node-install     Skip npm dependency installation
  --skip-python-install   Skip pip dependency installation
  --install-plugin-python-deps
                           Install Plugin/**/requirements.txt for selected components
  --strict-dependencies   Treat missing required commands as install errors
  --overwrite-config      Rewrite generated config files if already present
  --start-after-install   Start backend/chat after install flow
  --vcp-api-url <url>     Value for VCPToolBox API_URL
  --vcp-api-key <key>     Value for VCPToolBox API_Key
  --vcp-port <port>       Value for VCPToolBox PORT (default 6005)
  --vcp-key <key>         Value for VCPToolBox VCP_Key
  --admin-user <name>     Value for VCPToolBox AdminUsername
  --admin-password <pwd>  Value for VCPToolBox AdminPassword
  --chat-server-url <url> Value for VCPChat settings.vcpServerUrl
  --chat-api-key <key>    Value for VCPChat settings.vcpApiKey
  --chat-log-url <url>    Value for VCPChat settings.vcpLogUrl
  --chat-log-key <key>    Value for VCPChat settings.vcpLogKey
  --backend-cwd <dir>     Backend working directory
  --backend-cmd <cmd>     Backend startup command
  --chat-cwd <dir>        VCPChat working directory
  --chat-cmd <cmd>        VCPChat startup command
  --startup-delay <sec>   Delay between backend and chat startup
  --version               Print installer version
  --help                  Print this help

Examples:
  vcp-installer
  vcp-installer install --cli --yes --components all
  vcp-installer init --gui
  vcp-installer init --cli --yes --workspace-root ~/vcp --backend-cmd "node server.js" --chat-cmd "npm run start"
  vcp-installer start
  vcp-installer stop
  vcp-installer status
EOF
}

require_cmd_or_warn() {
  local cmd="$1"
  if command -v "${cmd}" >/dev/null 2>&1; then
    local line
    line="$("${cmd}" --version 2>/dev/null | head -n 1 || true)"
    if [ -n "${line}" ]; then
      log INFO "Detected ${cmd}: ${line}"
    else
      log INFO "Detected ${cmd}"
    fi
  else
    log WARN "Missing dependency: ${cmd}"
  fi
}

emit_gui_required_block() {
  cat <<EOF
GUI_REQUIRED
step_id: S45_GUI_REQUIRED
reason: This step requires an interactive GUI action.
user_action: Open GUI session and complete the required dialog.
completion_criteria: GUI action finished and confirmed.
resume_command: ${0} resume --cli
EOF
}

emit_init_required_block() {
  cat <<EOF
INIT_REQUIRED
step_id: S20_INITIALIZE
reason: Launcher config is missing and headless mode cannot open GUI wizard.
user_action: Run initialization with explicit commands.
completion_criteria: ${CONFIG_FILE} exists with backend/chat commands.
continue_command: ${0} init --cli --yes --backend-cwd <dir> --backend-cmd <cmd> --chat-cwd <dir> --chat-cmd <cmd>
EOF
}

write_state() {
  local session_file="$1"
  local step_id="$2"
  local status="$3"
  local detail="$4"
  cat > "${session_file}" <<EOF
{
  "session_id": "${SESSION_ID}",
  "mode": "${MODE}",
  "headless": ${HEADLESS},
  "dry_run": ${DRY_RUN},
  "step_id": "${step_id}",
  "status": "${status}",
  "detail": "${detail}",
  "updated_at": "$(timestamp)"
}
EOF
}

safe_pid_running() {
  local pid="$1"
  if [ -z "${pid}" ]; then
    return 1
  fi
  kill -0 "${pid}" >/dev/null 2>&1
}

detect_workspace_root() {
  if [ -n "${WORKSPACE_ROOT_ARG}" ]; then
    printf '%s\n' "${WORKSPACE_ROOT_ARG}"
    return
  fi

  if [ -n "${VCP_WORKSPACE_ROOT:-}" ]; then
    printf '%s\n' "${VCP_WORKSPACE_ROOT}"
    return
  fi

  local candidate
  candidate="$(cd "${ROOT_DIR}/.." && pwd)"
  if [ -d "${candidate}/VCPToolBox" ] || [ -d "${candidate}/VCPChat" ]; then
    printf '%s\n' "${candidate}"
    return
  fi

  if [ -n "${HOME:-}" ]; then
    printf '%s/vcp\n' "${HOME}"
    return
  fi

  printf '%s\n' "${ROOT_DIR}"
}

add_install_warning() {
  local message="$1"
  INSTALL_WARNINGS+=("${message}")
  if [ "${INSTALL_STATUS}" != "failed" ]; then
    INSTALL_STATUS="warning"
  fi
}

add_install_error() {
  local message="$1"
  INSTALL_ERRORS+=("${message}")
  INSTALL_STATUS="failed"
}

add_install_step() {
  local step_id="$1"
  local status="$2"
  local detail="$3"
  INSTALL_STEPS+=("${step_id}|${status}|${detail}")
}

json_escape() {
  local value="$1"
  value="${value//\\/\\\\}"
  value="${value//\"/\\\"}"
  value="${value//$'\n'/\\n}"
  value="${value//$'\r'/\\r}"
  value="${value//$'\t'/\\t}"
  printf '%s' "${value}"
}

random_token() {
  local size="${1:-24}"
  local token
  token="$(cat /proc/sys/kernel/random/uuid 2>/dev/null | tr -d '-')"
  if [ -z "${token}" ]; then
    token="$(date +%s%N)"
  fi
  printf '%s\n' "${token}" | cut -c1-"${size}"
}

upsert_env_value() {
  local file_path="$1"
  local key="$2"
  local value="$3"
  local tmp_file="${file_path}.tmp.$$"

  awk -v k="${key}" -v v="${value}" '
    BEGIN { replaced = 0 }
    $0 ~ ("^" k "=") { print k "=" v; replaced = 1; next }
    { print }
    END { if (replaced == 0) print k "=" v }
  ' "${file_path}" > "${tmp_file}"

  mv "${tmp_file}" "${file_path}"
}

run_step_command() {
  local step_id="$1"
  local workdir="$2"
  local command="$3"

  log INFO "${step_id}: ${command}"
  log INFO "${step_id}: cwd=${workdir}"

  if [ "${DRY_RUN}" -eq 1 ]; then
    log INFO "${step_id}: dry-run, skipped command"
    return 0
  fi

  (
    cd "${workdir}"
    bash -lc "${command}"
  )
}

parse_install_components() {
  local normalized
  local token

  INSTALL_TOOLBOX_ENABLED=0
  INSTALL_CHAT_ENABLED=0

  normalized="$(printf '%s' "${INSTALL_COMPONENTS_ARG}" | tr ',' ' ' | tr '[:upper:]' '[:lower:]')"

  if [ -z "${normalized// /}" ] || [ "${normalized}" = "all" ]; then
    INSTALL_TOOLBOX_ENABLED=1
    INSTALL_CHAT_ENABLED=1
    return 0
  fi

  for token in ${normalized}; do
    case "${token}" in
      all)
        INSTALL_TOOLBOX_ENABLED=1
        INSTALL_CHAT_ENABLED=1
        ;;
      toolbox|vcptoolbox|backend)
        INSTALL_TOOLBOX_ENABLED=1
        ;;
      chat|vcpchat|frontend)
        INSTALL_CHAT_ENABLED=1
        ;;
      *)
        echo "Invalid --components value: ${INSTALL_COMPONENTS_ARG}" >&2
        echo "Supported values: all | toolbox | chat | toolbox,chat" >&2
        return 1
        ;;
    esac
  done

  if [ "${INSTALL_TOOLBOX_ENABLED}" -eq 0 ] && [ "${INSTALL_CHAT_ENABLED}" -eq 0 ]; then
    echo "No install component selected." >&2
    return 1
  fi

  return 0
}

setup_vcptoolbox_config() {
  local toolbox_dir="$1"
  local chat_dir="$2"
  local config_file="${toolbox_dir}/config.env"
  local config_example="${toolbox_dir}/config.env.example"
  local api_url="${VCP_API_URL_ARG:-http://127.0.0.1:3000}"
  local api_key="${VCP_API_KEY_ARG:-sk-change-me}"
  local vcp_port="${VCP_PORT_ARG:-6005}"
  local admin_user="${ADMIN_USER_ARG:-admin}"
  local admin_password="${ADMIN_PASSWORD_ARG:-$(random_token 20)}"
  local service_key
  local image_key
  local file_key
  local vcp_key
  local callback_url

  service_key="Key_$(random_token 16)"
  image_key="Images_$(random_token 12)"
  file_key="$(random_token 12)"
  vcp_key="${VCP_KEY_ARG:-$(random_token 24)}"
  callback_url="http://127.0.0.1:${vcp_port}/plugin-callback"

  if [ -f "${config_file}" ] && [ "${FORCE_CONFIG_REWRITE}" -eq 0 ]; then
    log INFO "VCPToolBox config exists, keeping current file: ${config_file}"
  else
    if [ "${DRY_RUN}" -eq 1 ]; then
      log INFO "Dry-run: would create/update ${config_file}"
    else
      if [ -f "${config_example}" ]; then
        cp "${config_example}" "${config_file}"
      else
        cat > "${config_file}" <<'EOF'
API_Key=sk-change-me
API_URL=http://127.0.0.1:3000
PORT=6005
Key=change-me
Image_Key=Images_change_me
File_Key=change_me
VCP_Key=change-me
AdminUsername=admin
AdminPassword=change-me
CALLBACK_BASE_URL=http://127.0.0.1:6005/plugin-callback
EOF
      fi
    fi
  fi

  if [ "${DRY_RUN}" -eq 0 ] && [ -f "${config_file}" ]; then
    upsert_env_value "${config_file}" "API_URL" "${api_url}"
    upsert_env_value "${config_file}" "API_Key" "${api_key}"
    upsert_env_value "${config_file}" "PORT" "${vcp_port}"
    upsert_env_value "${config_file}" "Key" "${service_key}"
    upsert_env_value "${config_file}" "Image_Key" "${image_key}"
    upsert_env_value "${config_file}" "File_Key" "${file_key}"
    upsert_env_value "${config_file}" "VCP_Key" "${vcp_key}"
    upsert_env_value "${config_file}" "AdminUsername" "${admin_user}"
    upsert_env_value "${config_file}" "AdminPassword" "${admin_password}"
    upsert_env_value "${config_file}" "CALLBACK_BASE_URL" "${callback_url}"
    upsert_env_value "${config_file}" "VarVchatPath" "${chat_dir}"
    chmod 600 "${config_file}" || true
  fi

  if [ "${DRY_RUN}" -eq 0 ]; then
    mkdir -p \
      "${toolbox_dir}/VCPTimedContacts" \
      "${toolbox_dir}/dailynote" \
      "${toolbox_dir}/image" \
      "${toolbox_dir}/file" \
      "${toolbox_dir}/TVStxt" \
      "${toolbox_dir}/VCPAsyncResults" \
      "${toolbox_dir}/Plugin/VCPLog/log" \
      "${toolbox_dir}/Plugin/EmojiListGenerator/generated_lists" \
      "${toolbox_dir}/VectorStore"
  else
    log INFO "Dry-run: would create VCPToolBox runtime directories"
  fi
}

setup_vcpchat_config() {
  local chat_dir="$1"
  local toolbox_dir="$2"
  local api_port="${VCP_PORT_ARG:-6005}"
  local settings_dir="${chat_dir}/AppData"
  local settings_file="${settings_dir}/settings.json"
  local server_url="${CHAT_SERVER_URL_ARG:-http://127.0.0.1:${api_port}/v1/chat/completions}"
  local api_key="${CHAT_API_KEY_ARG:-${VCP_API_KEY_ARG:-sk-change-me}}"
  local log_url="${CHAT_LOG_URL_ARG:-http://127.0.0.1:${api_port}}"
  local log_key="${CHAT_LOG_KEY_ARG:-${VCP_KEY_ARG:-$(random_token 20)}}"

  if [ "${DRY_RUN}" -eq 0 ]; then
    mkdir -p \
      "${settings_dir}" \
      "${settings_dir}/Agents" \
      "${settings_dir}/UserData" \
      "${settings_dir}/UserData/attachments" \
      "${settings_dir}/Notemodules" \
      "${settings_dir}/file" \
      "${settings_dir}/canvas"
  else
    log INFO "Dry-run: would create VCPChat AppData directories under ${settings_dir}"
  fi

  if [ -f "${settings_file}" ] && [ "${FORCE_CONFIG_REWRITE}" -eq 0 ]; then
    log INFO "VCPChat settings exists, keeping current file: ${settings_file}"
    return
  fi

  if [ "${DRY_RUN}" -eq 1 ]; then
    log INFO "Dry-run: would generate ${settings_file}"
    return
  fi

  cat > "${settings_file}" <<EOF
{
  "sidebarWidth": 260,
  "notificationsSidebarWidth": 300,
  "userName": "用户",
  "vcpServerUrl": "$(json_escape "${server_url}")",
  "vcpApiKey": "$(json_escape "${api_key}")",
  "vcpLogUrl": "$(json_escape "${log_url}")",
  "vcpLogKey": "$(json_escape "${log_key}")",
  "networkNotesPaths": [],
  "enableAgentBubbleTheme": false,
  "enableSmoothStreaming": false,
  "minChunkBufferSize": 1,
  "smoothStreamIntervalMs": 25,
  "assistantAgent": "",
  "enableDistributedServer": true,
  "agentMusicControl": false,
  "enableDistributedServerLogs": false,
  "enableVcpToolInjection": false,
  "lastOpenItemId": null,
  "lastOpenItemType": null,
  "lastOpenTopicId": null,
  "combinedItemOrder": [],
  "agentOrder": [],
  "vcpToolBoxPath": "$(json_escape "${toolbox_dir}")"
}
EOF
}

detect_package_manager() {
  if command -v apt-get >/dev/null 2>&1; then
    printf '%s\n' "apt"
    return
  fi
  if command -v dnf >/dev/null 2>&1; then
    printf '%s\n' "dnf"
    return
  fi
  if command -v yum >/dev/null 2>&1; then
    printf '%s\n' "yum"
    return
  fi
  if command -v pacman >/dev/null 2>&1; then
    printf '%s\n' "pacman"
    return
  fi
  if command -v zypper >/dev/null 2>&1; then
    printf '%s\n' "zypper"
    return
  fi
  printf '%s\n' "unknown"
}

build_install_hint() {
  local command_name="$1"
  local manager="$2"
  case "${manager}" in
    apt)
      printf '%s\n' "sudo apt-get update && sudo apt-get install -y ${command_name}"
      ;;
    dnf)
      printf '%s\n' "sudo dnf install -y ${command_name}"
      ;;
    yum)
      printf '%s\n' "sudo yum install -y ${command_name}"
      ;;
    pacman)
      printf '%s\n' "sudo pacman -Sy --noconfirm ${command_name}"
      ;;
    zypper)
      printf '%s\n' "sudo zypper install -y ${command_name}"
      ;;
    *)
      printf '%s\n' "<package-manager> install ${command_name}"
      ;;
  esac
}

check_required_command() {
  local command_name="$1"
  local reason="$2"
  local package_manager="$3"

  if command -v "${command_name}" >/dev/null 2>&1; then
    local line
    line="$("${command_name}" --version 2>/dev/null | head -n 1 || true)"
    if [ -n "${line}" ]; then
      log INFO "Dependency ${command_name} detected: ${line}"
    else
      log INFO "Dependency ${command_name} detected"
    fi
    return 0
  fi

  local hint
  local message
  hint="$(build_install_hint "${command_name}" "${package_manager}")"
  message="Missing command '${command_name}' (${reason}). Suggestion: ${hint}"

  if [ "${STRICT_DEPENDENCIES}" -eq 1 ]; then
    add_install_error "${message}"
    log ERROR "${message}"
  else
    add_install_warning "${message}"
    log WARN "${message}"
  fi

  return 1
}

install_plugin_python_requirements() {
  local component_name="$1"
  local component_dir="$2"
  local plugin_root="${component_dir}/Plugin"
  local req_file
  local req_files=()
  local req_dir
  local rel_path

  if [ ! -d "${plugin_root}" ]; then
    log INFO "${component_name}: no Plugin directory detected, skip plugin python dependencies"
    return 0
  fi

  while IFS= read -r -d '' req_file; do
    req_files+=("${req_file}")
  done < <(find "${plugin_root}" -type f -name requirements.txt -print0 2>/dev/null)

  if [ "${#req_files[@]}" -eq 0 ]; then
    log INFO "${component_name}: no plugin requirements.txt files found"
    return 0
  fi

  log INFO "${component_name}: found ${#req_files[@]} plugin requirements file(s)"

  if [ "${SKIP_PYTHON_INSTALL}" -eq 1 ]; then
    add_install_warning "${component_name}: plugin python requirements skipped because --skip-python-install is enabled"
    return 0
  fi

  for req_file in "${req_files[@]}"; do
    req_dir="$(dirname "${req_file}")"
    rel_path="${req_file#${component_dir}/}"
    if [ "${DRY_RUN}" -eq 1 ]; then
      log INFO "Dry-run: would install plugin python requirements from ${rel_path}"
      continue
    fi

    if command -v pip3 >/dev/null 2>&1; then
      run_step_command "S42_${component_name}_PLUGIN_PY" "${req_dir}" "pip3 install -r requirements.txt"
    elif command -v python3 >/dev/null 2>&1; then
      run_step_command "S42_${component_name}_PLUGIN_PY" "${req_dir}" "python3 -m pip install -r requirements.txt"
    else
      add_install_error "${component_name}: cannot install plugin python requirements because pip3/python3 is missing (${rel_path})"
      return 1
    fi
  done

  return 0
}

install_component_dependencies() {
  local component_name="$1"
  local component_dir="$2"

  if [ "${SKIP_NODE_INSTALL}" -eq 0 ] && [ -f "${component_dir}/package.json" ]; then
    run_step_command "S40_${component_name}_NODE" "${component_dir}" "npm install --no-audit --no-fund"
  else
    add_install_warning "${component_name}: node install skipped"
    log WARN "${component_name}: node install skipped"
  fi

  if [ "${SKIP_PYTHON_INSTALL}" -eq 0 ] && [ -f "${component_dir}/requirements.txt" ]; then
    if command -v pip3 >/dev/null 2>&1; then
      run_step_command "S41_${component_name}_PY" "${component_dir}" "pip3 install -r requirements.txt"
    elif command -v python3 >/dev/null 2>&1; then
      run_step_command "S41_${component_name}_PY" "${component_dir}" "python3 -m pip install -r requirements.txt"
    else
      add_install_warning "${component_name}: python dependency install skipped (pip/python3 not found)"
      log WARN "${component_name}: python dependency install skipped (pip/python3 not found)"
    fi
  elif [ "${SKIP_PYTHON_INSTALL}" -eq 1 ]; then
    add_install_warning "${component_name}: python install skipped by flag"
    log WARN "${component_name}: python install skipped by flag"
  fi
}

write_install_report() {
  local workspace_root="$1"
  local toolbox_dir="$2"
  local chat_dir="$3"
  local now_iso
  local idx
  local step_row
  local step_id
  local step_status
  local step_detail

  now_iso="$(timestamp)"
  REPORT_DIR="${INSTALLER_HOME}/reports"
  INSTALL_REPORT_JSON="${REPORT_DIR}/install-report-${SESSION_ID}.json"
  INSTALL_REPORT_MD="${REPORT_DIR}/install-report-${SESSION_ID}.md"

  if [ "${DRY_RUN}" -eq 1 ]; then
    log INFO "Dry-run: would write install reports to ${REPORT_DIR}"
    return
  fi

  mkdir -p "${REPORT_DIR}"

  {
    printf '{\n'
    printf '  "session_id": "%s",\n' "$(json_escape "${SESSION_ID}")"
    printf '  "generated_at": "%s",\n' "$(json_escape "${now_iso}")"
    printf '  "status": "%s",\n' "$(json_escape "${INSTALL_STATUS}")"
    printf '  "workspace_root": "%s",\n' "$(json_escape "${workspace_root}")"
    printf '  "toolbox_dir": "%s",\n' "$(json_escape "${toolbox_dir}")"
    printf '  "chat_dir": "%s",\n' "$(json_escape "${chat_dir}")"
    printf '  "warnings": [\n'
    for idx in "${!INSTALL_WARNINGS[@]}"; do
      printf '    "%s"' "$(json_escape "${INSTALL_WARNINGS[$idx]}")"
      if [ "${idx}" -lt "$((${#INSTALL_WARNINGS[@]} - 1))" ]; then
        printf ','
      fi
      printf '\n'
    done
    printf '  ],\n'
    printf '  "errors": [\n'
    for idx in "${!INSTALL_ERRORS[@]}"; do
      printf '    "%s"' "$(json_escape "${INSTALL_ERRORS[$idx]}")"
      if [ "${idx}" -lt "$((${#INSTALL_ERRORS[@]} - 1))" ]; then
        printf ','
      fi
      printf '\n'
    done
    printf '  ],\n'
    printf '  "steps": [\n'
    for idx in "${!INSTALL_STEPS[@]}"; do
      step_row="${INSTALL_STEPS[$idx]}"
      step_id="${step_row%%|*}"
      step_row="${step_row#*|}"
      step_status="${step_row%%|*}"
      step_detail="${step_row#*|}"
      printf '    {"step_id":"%s","status":"%s","detail":"%s"}' \
        "$(json_escape "${step_id}")" \
        "$(json_escape "${step_status}")" \
        "$(json_escape "${step_detail}")"
      if [ "${idx}" -lt "$((${#INSTALL_STEPS[@]} - 1))" ]; then
        printf ','
      fi
      printf '\n'
    done
    printf '  ]\n'
    printf '}\n'
  } > "${INSTALL_REPORT_JSON}"

  {
    printf '# Install Report\n\n'
    printf -- '- Session: `%s`\n' "${SESSION_ID}"
    printf -- '- Generated At (UTC): `%s`\n' "${now_iso}"
    printf -- '- Status: `%s`\n' "${INSTALL_STATUS}"
    printf -- '- Workspace: `%s`\n' "${workspace_root}"
    printf -- '- VCPToolBox: `%s`\n' "${toolbox_dir}"
    printf -- '- VCPChat: `%s`\n' "${chat_dir}"
    printf '\n## Steps\n\n'
    for step_row in "${INSTALL_STEPS[@]}"; do
      step_id="${step_row%%|*}"
      step_row="${step_row#*|}"
      step_status="${step_row%%|*}"
      step_detail="${step_row#*|}"
      printf -- '- `%s` `%s` %s\n' "${step_id}" "${step_status}" "${step_detail}"
    done
    printf '\n## Warnings\n\n'
    if [ "${#INSTALL_WARNINGS[@]}" -eq 0 ]; then
      printf -- '- none\n'
    else
      for step_row in "${INSTALL_WARNINGS[@]}"; do
        printf -- '- %s\n' "${step_row}"
      done
    fi
    printf '\n## Errors\n\n'
    if [ "${#INSTALL_ERRORS[@]}" -eq 0 ]; then
      printf -- '- none\n'
    else
      for step_row in "${INSTALL_ERRORS[@]}"; do
        printf -- '- %s\n' "${step_row}"
      done
    fi
  } > "${INSTALL_REPORT_MD}"

  log INFO "Install report JSON: ${INSTALL_REPORT_JSON}"
  log INFO "Install report Markdown: ${INSTALL_REPORT_MD}"
}

save_launcher_config() {
  local workspace_root="$1"
  local backend_cwd="$2"
  local backend_cmd="$3"
  local chat_cwd="$4"
  local chat_cmd="$5"
  local startup_delay="$6"

  if [ "${DRY_RUN}" -eq 1 ]; then
    log INFO "Dry-run: skip writing launcher config (${CONFIG_FILE})"
    return
  fi

  {
    printf '# Generated by vcp-installer at %s\n' "$(timestamp)"
    printf 'CONFIG_VERSION=%q\n' "1"
    printf 'INITIALIZED_AT=%q\n' "$(timestamp)"
    printf 'WORKSPACE_ROOT=%q\n' "${workspace_root}"
    printf 'BACKEND_CWD=%q\n' "${backend_cwd}"
    printf 'BACKEND_CMD=%q\n' "${backend_cmd}"
    printf 'CHAT_CWD=%q\n' "${chat_cwd}"
    printf 'CHAT_CMD=%q\n' "${chat_cmd}"
    printf 'STARTUP_DELAY_CFG=%q\n' "${startup_delay}"
  } > "${CONFIG_FILE}"

  chmod 600 "${CONFIG_FILE}"
}

load_launcher_config() {
  if [ ! -f "${CONFIG_FILE}" ]; then
    return 1
  fi

  # shellcheck disable=SC1090
  source "${CONFIG_FILE}"

  if [ -z "${BACKEND_CWD:-}" ] || [ -z "${BACKEND_CMD:-}" ] || [ -z "${CHAT_CWD:-}" ] || [ -z "${CHAT_CMD:-}" ]; then
    log ERROR "Launcher config is incomplete: ${CONFIG_FILE}"
    return 2
  fi

  return 0
}

prompt_cli_value() {
  local prompt="$1"
  local default_value="$2"
  local input=""

  read -r -p "${prompt} [${default_value}]: " input || true
  if [ -z "${input}" ]; then
    printf '%s\n' "${default_value}"
  else
    printf '%s\n' "${input}"
  fi
}

collect_init_values() {
  local default_workspace
  local default_backend_cwd
  local default_backend_cmd
  local default_chat_cwd
  local default_chat_cmd

  default_workspace="$(detect_workspace_root)"
  default_backend_cwd="${default_workspace}/VCPToolBox"
  default_backend_cmd="node server.js"
  default_chat_cwd="${default_workspace}/VCPChat"
  default_chat_cmd="npm run start"

  WORKSPACE_ROOT_VAL="${WORKSPACE_ROOT_ARG:-${default_workspace}}"
  BACKEND_CWD_VAL="${BACKEND_CWD_ARG:-${default_backend_cwd}}"
  BACKEND_CMD_VAL="${BACKEND_CMD_ARG:-${default_backend_cmd}}"
  CHAT_CWD_VAL="${CHAT_CWD_ARG:-${default_chat_cwd}}"
  CHAT_CMD_VAL="${CHAT_CMD_ARG:-${default_chat_cmd}}"

  if [ "${HEADLESS}" -eq 1 ] && [ "${AUTO_APPROVE}" -eq 0 ]; then
    emit_init_required_block
    exit 31
  fi

  if [ "${AUTO_APPROVE}" -eq 1 ]; then
    return
  fi

  if [ "${MODE}" = "gui" ] && [ -n "${DISPLAY:-}" ] && command -v zenity >/dev/null 2>&1; then
    local sep=$'\x1f'
    local form_output

    form_output="$(zenity --forms \
      --title="VCP Installer Initialization" \
      --text="Set startup profile for backend and VCPChat." \
      --separator="${sep}" \
      --add-entry="Workspace Root" \
      --add-entry="Backend Working Directory" \
      --add-entry="Backend Start Command" \
      --add-entry="VCPChat Working Directory" \
      --add-entry="VCPChat Start Command" \
      --add-entry="Startup Delay Seconds")"

    if [ -z "${form_output}" ]; then
      log WARN "Initialization wizard cancelled."
      exit 4
    fi

    IFS="${sep}" read -r WORKSPACE_ROOT_VAL BACKEND_CWD_VAL BACKEND_CMD_VAL CHAT_CWD_VAL CHAT_CMD_VAL STARTUP_DELAY_FORM <<< "${form_output}"
    if [ -n "${STARTUP_DELAY_FORM:-}" ]; then
      STARTUP_DELAY="${STARTUP_DELAY_FORM}"
    fi
  else
    WORKSPACE_ROOT_VAL="$(prompt_cli_value "Workspace root" "${WORKSPACE_ROOT_VAL}")"
    BACKEND_CWD_VAL="$(prompt_cli_value "Backend working directory" "${BACKEND_CWD_VAL}")"
    BACKEND_CMD_VAL="$(prompt_cli_value "Backend start command" "${BACKEND_CMD_VAL}")"
    CHAT_CWD_VAL="$(prompt_cli_value "VCPChat working directory" "${CHAT_CWD_VAL}")"
    CHAT_CMD_VAL="$(prompt_cli_value "VCPChat start command" "${CHAT_CMD_VAL}")"
    STARTUP_DELAY="$(prompt_cli_value "Startup delay seconds" "${STARTUP_DELAY}")"
  fi
}

validate_startup_delay() {
  if ! printf '%s' "${STARTUP_DELAY}" | grep -Eq '^[0-9]+$'; then
    echo "Invalid --startup-delay: ${STARTUP_DELAY}" >&2
    exit 2
  fi
}

validate_vcp_port() {
  if [ -z "${VCP_PORT_ARG}" ]; then
    return
  fi

  if ! printf '%s' "${VCP_PORT_ARG}" | grep -Eq '^[0-9]+$'; then
    echo "Invalid --vcp-port: ${VCP_PORT_ARG}" >&2
    exit 2
  fi
}

start_component() {
  local name="$1"
  local cwd="$2"
  local cmd="$3"
  local pid_file="${RUN_DIR}/${name}.pid"
  local log_file="${LOG_DIR}/${name}.log"

  if [ -f "${pid_file}" ]; then
    local existing_pid
    existing_pid="$(cat "${pid_file}" 2>/dev/null || true)"
    if safe_pid_running "${existing_pid}"; then
      log INFO "${name} already running (pid=${existing_pid})."
      return 0
    fi
    rm -f "${pid_file}"
  fi

  if [ ! -d "${cwd}" ]; then
    log ERROR "${name} working directory not found: ${cwd}"
    return 21
  fi

  if [ "${DRY_RUN}" -eq 1 ]; then
    log INFO "Dry-run: would start ${name}"
    log INFO "  cwd=${cwd}"
    log INFO "  cmd=${cmd}"
    return 0
  fi

  (
    cd "${cwd}"
    nohup bash -lc "${cmd}" >> "${log_file}" 2>&1 &
    echo $! > "${pid_file}"
  )

  local new_pid
  new_pid="$(cat "${pid_file}")"
  log INFO "${name} started (pid=${new_pid})"
  log INFO "${name} log file: ${log_file}"
}

stop_component() {
  local name="$1"
  local pid_file="${RUN_DIR}/${name}.pid"

  if [ ! -f "${pid_file}" ]; then
    log INFO "${name} is not running (no pid file)."
    return 0
  fi

  local pid
  pid="$(cat "${pid_file}" 2>/dev/null || true)"

  if ! safe_pid_running "${pid}"; then
    rm -f "${pid_file}"
    log INFO "${name} pid was stale; cleaned pid file."
    return 0
  fi

  if [ "${DRY_RUN}" -eq 1 ]; then
    log INFO "Dry-run: would stop ${name} (pid=${pid})"
    return 0
  fi

  kill "${pid}" 2>/dev/null || true

  local i
  for i in 1 2 3 4 5 6 7 8 9 10; do
    if safe_pid_running "${pid}"; then
      sleep 0.3
    else
      break
    fi
  done

  if safe_pid_running "${pid}"; then
    kill -9 "${pid}" 2>/dev/null || true
  fi

  rm -f "${pid_file}"
  log INFO "${name} stopped"
}

show_component_status() {
  local name="$1"
  local pid_file="${RUN_DIR}/${name}.pid"

  if [ ! -f "${pid_file}" ]; then
    printf '%s: STOPPED\n' "${name}"
    return
  fi

  local pid
  pid="$(cat "${pid_file}" 2>/dev/null || true)"
  if safe_pid_running "${pid}"; then
    printf '%s: RUNNING (pid=%s)\n' "${name}" "${pid}"
  else
    printf '%s: STOPPED (stale pid file)\n' "${name}"
  fi
}

run_install_flow() {
  local session_file="$1"
  local workspace_root
  local toolbox_dir
  local chat_dir
  local backend_cmd
  local chat_cmd
  local package_manager
  local precheck_status

  INSTALL_STATUS="success"
  INSTALL_WARNINGS=()
  INSTALL_ERRORS=()
  INSTALL_STEPS=()

  write_state "${session_file}" "S00_PRECHECK" "running" "precheck-started"
  log INFO "Step S00_PRECHECK: validating runtime dependencies"
  package_manager="$(detect_package_manager)"
  check_required_command "git" "source checkout and update operations" "${package_manager}" || true
  if [ "${SKIP_NODE_INSTALL}" -eq 0 ] || [ "${START_AFTER_INSTALL}" -eq 1 ]; then
    check_required_command "node" "component runtime and build scripts" "${package_manager}" || true
  fi
  if [ "${SKIP_NODE_INSTALL}" -eq 0 ]; then
    check_required_command "npm" "node dependency installation" "${package_manager}" || true
  fi
  if [ "${SKIP_PYTHON_INSTALL}" -eq 0 ] || [ "${INSTALL_PLUGIN_PYTHON_DEPS}" -eq 1 ]; then
    check_required_command "python3" "python dependencies and helper scripts" "${package_manager}" || true
  fi
  if [ "${SKIP_PYTHON_INSTALL}" -eq 0 ]; then
    if ! command -v pip3 >/dev/null 2>&1 && ! command -v python3 >/dev/null 2>&1; then
      check_required_command "pip3" "python dependency installation" "${package_manager}" || true
    fi
  fi
  if [ "${INSTALL_STATUS}" = "failed" ]; then
    precheck_status="failed"
  elif [ "${INSTALL_STATUS}" = "warning" ]; then
    precheck_status="warning"
  else
    precheck_status="success"
  fi
  add_install_step "S00_PRECHECK" "${precheck_status}" "runtime dependency check finished (pkg-manager=${package_manager})"

  if ! parse_install_components; then
    write_state "${session_file}" "S05_COMPONENTS" "failed" "invalid-component-selection"
    exit 2
  fi

  write_state "${session_file}" "S05_COMPONENTS" "running" "component-selection"
  add_install_step \
    "S05_COMPONENTS" \
    "success" \
    "toolbox=${INSTALL_TOOLBOX_ENABLED},chat=${INSTALL_CHAT_ENABLED}"

  workspace_root="$(detect_workspace_root)"
  toolbox_dir="${workspace_root}/VCPToolBox"
  chat_dir="${workspace_root}/VCPChat"

  write_state "${session_file}" "S10_WORKSPACE" "running" "workspace-detection"
  log INFO "Step S10_WORKSPACE: workspace root ${workspace_root}"
  add_install_step "S10_WORKSPACE" "success" "workspace=${workspace_root}"

  if [ "${SIMULATE_GUI_STEP}" -eq 1 ]; then
    write_state "${session_file}" "S45_GUI_REQUIRED" "blocked" "gui-required-step"
    add_install_step "S45_GUI_REQUIRED" "blocked" "simulated gui-required step"
    if [ "${HEADLESS}" -eq 1 ]; then
      emit_gui_required_block
      exit 30
    fi

    if [ "${MODE}" = "gui" ] && [ -n "${DISPLAY:-}" ] && command -v zenity >/dev/null 2>&1; then
      zenity --info --title "VCP Installer" --text "GUI required step simulated. Click OK to continue." || true
    else
      log WARN "GUI required step simulated without zenity; continuing in non-interactive fallback."
    fi
  fi

  if [ "${INSTALL_TOOLBOX_ENABLED}" -eq 1 ]; then
    write_state "${session_file}" "S50_TOOLBOX" "running" "installing-vcptoolbox"
    if [ ! -d "${toolbox_dir}" ]; then
      if [ "${DRY_RUN}" -eq 1 ]; then
        add_install_warning "VCPToolBox directory not found (dry-run): ${toolbox_dir}"
        add_install_step "S50_TOOLBOX" "warning" "missing directory in dry-run"
      else
        add_install_error "VCPToolBox directory not found: ${toolbox_dir}"
        add_install_step "S50_TOOLBOX" "failed" "missing directory"
      fi
    else
      if install_component_dependencies "TOOLBOX" "${toolbox_dir}"; then
        if [ "${INSTALL_PLUGIN_PYTHON_DEPS}" -eq 1 ]; then
          install_plugin_python_requirements "TOOLBOX" "${toolbox_dir}" || true
        fi
        setup_vcptoolbox_config "${toolbox_dir}" "${chat_dir}"
        if [ "${DRY_RUN}" -eq 1 ] || [ -f "${toolbox_dir}/config.env" ]; then
          add_install_step "S50_TOOLBOX" "success" "dependency/config completed"
        else
          add_install_error "VCPToolBox config generation failed: ${toolbox_dir}/config.env"
          add_install_step "S50_TOOLBOX" "failed" "config file missing"
        fi
      else
        add_install_error "VCPToolBox dependency installation failed"
        add_install_step "S50_TOOLBOX" "failed" "dependency install failed"
      fi
    fi
  fi

  if [ "${INSTALL_CHAT_ENABLED}" -eq 1 ]; then
    write_state "${session_file}" "S51_CHAT" "running" "installing-vcpchat"
    if [ ! -d "${chat_dir}" ]; then
      if [ "${DRY_RUN}" -eq 1 ]; then
        add_install_warning "VCPChat directory not found (dry-run): ${chat_dir}"
        add_install_step "S51_CHAT" "warning" "missing directory in dry-run"
      else
        add_install_error "VCPChat directory not found: ${chat_dir}"
        add_install_step "S51_CHAT" "failed" "missing directory"
      fi
    else
      if install_component_dependencies "CHAT" "${chat_dir}"; then
        if [ "${INSTALL_PLUGIN_PYTHON_DEPS}" -eq 1 ]; then
          install_plugin_python_requirements "CHAT" "${chat_dir}" || true
        fi
        setup_vcpchat_config "${chat_dir}" "${toolbox_dir}"
        if [ "${DRY_RUN}" -eq 1 ] || [ -f "${chat_dir}/AppData/settings.json" ]; then
          add_install_step "S51_CHAT" "success" "dependency/config completed"
        else
          add_install_error "VCPChat settings generation failed: ${chat_dir}/AppData/settings.json"
          add_install_step "S51_CHAT" "failed" "settings file missing"
        fi
      else
        add_install_error "VCPChat dependency installation failed"
        add_install_step "S51_CHAT" "failed" "dependency install failed"
      fi
    fi
  fi

  write_state "${session_file}" "S70_REPORT" "running" "report-generation"
  write_install_report "${workspace_root}" "${toolbox_dir}" "${chat_dir}"

  if [ "${START_AFTER_INSTALL}" -eq 1 ] && [ "${INSTALL_STATUS}" != "failed" ]; then
    backend_cmd="${BACKEND_CMD_ARG:-node server.js}"
    chat_cmd="${CHAT_CMD_ARG:-npm run start}"
    save_launcher_config \
      "${workspace_root}" \
      "${toolbox_dir}" \
      "${backend_cmd}" \
      "${chat_dir}" \
      "${chat_cmd}" \
      "${STARTUP_DELAY}"
    if [ "${DRY_RUN}" -eq 1 ]; then
      add_install_step "S80_START_STACK" "warning" "dry-run skipped stack startup"
    else
      run_start_stack
      add_install_step "S80_START_STACK" "success" "stack startup executed"
    fi
  fi

  if [ "${INSTALL_STATUS}" = "failed" ]; then
    write_state "${session_file}" "S90_DONE" "failed" "install-failed"
    log ERROR "Install flow completed with errors."
    exit 24
  fi

  if [ "${INSTALL_STATUS}" = "warning" ]; then
    write_state "${session_file}" "S90_DONE" "warning" "install-completed-with-warnings"
    log WARN "Install flow completed with warnings."
  else
    write_state "${session_file}" "S90_DONE" "success" "install-completed"
    log INFO "Install flow completed successfully."
  fi
}

run_init() {
  write_state "${SESSION_FILE}" "S20_INITIALIZE" "running" "collect-launch-profile"
  collect_init_values
  validate_startup_delay

  if [ -z "${BACKEND_CMD_VAL}" ] || [ -z "${CHAT_CMD_VAL}" ]; then
    log ERROR "Initialization failed: backend/chat command cannot be empty"
    write_state "${SESSION_FILE}" "S20_INITIALIZE" "failed" "empty-command"
    exit 22
  fi

  save_launcher_config \
    "${WORKSPACE_ROOT_VAL}" \
    "${BACKEND_CWD_VAL}" \
    "${BACKEND_CMD_VAL}" \
    "${CHAT_CWD_VAL}" \
    "${CHAT_CMD_VAL}" \
    "${STARTUP_DELAY}"

  log INFO "Initialization completed. Config: ${CONFIG_FILE}"
  write_state "${SESSION_FILE}" "S20_INITIALIZE" "success" "config-saved"
}

run_start_stack() {
  if ! load_launcher_config; then
    log ERROR "Launcher config not found: ${CONFIG_FILE}"
    log INFO "Run init first: ${0} init --gui"
    exit 23
  fi

  local delay_to_use="${STARTUP_DELAY}"
  if [ -n "${STARTUP_DELAY_CFG:-}" ] && [ "${STARTUP_DELAY}" = "2" ]; then
    delay_to_use="${STARTUP_DELAY_CFG}"
  fi

  if ! printf '%s' "${delay_to_use}" | grep -Eq '^[0-9]+$'; then
    delay_to_use="2"
  fi

  write_state "${SESSION_FILE}" "S60_START_STACK" "running" "starting-backend-chat"
  log INFO "Starting stack from config: ${CONFIG_FILE}"

  start_component "backend" "${BACKEND_CWD}" "${BACKEND_CMD}"

  if [ "${DRY_RUN}" -eq 0 ] && [ "${delay_to_use}" -gt 0 ]; then
    sleep "${delay_to_use}"
  fi

  start_component "chat" "${CHAT_CWD}" "${CHAT_CMD}"

  write_state "${SESSION_FILE}" "S60_START_STACK" "success" "stack-started"
  log INFO "Stack startup finished"
}

run_stop_stack() {
  write_state "${SESSION_FILE}" "S61_STOP_STACK" "running" "stopping-backend-chat"
  stop_component "chat"
  stop_component "backend"
  write_state "${SESSION_FILE}" "S61_STOP_STACK" "success" "stack-stopped"
}

run_status() {
  if [ -f "${CONFIG_FILE}" ]; then
    # shellcheck disable=SC1090
    source "${CONFIG_FILE}"
    printf 'Config: %s\n' "${CONFIG_FILE}"
    printf 'Workspace: %s\n' "${WORKSPACE_ROOT:-<unset>}"
  else
    printf 'Config: <not initialized>\n'
  fi

  show_component_status "backend"
  show_component_status "chat"
}

run_reset() {
  if [ "${DRY_RUN}" -eq 1 ]; then
    log INFO "Dry-run: would remove launcher config and runtime state under ${INSTALLER_HOME}"
    return
  fi

  rm -f "${CONFIG_FILE}" "${RUN_DIR}"/*.pid
  log INFO "Reset completed. Config and pid files removed."
}

while [ $# -gt 0 ]; do
  case "$1" in
    install|resume|init|start|stop|status|reset)
      COMMAND="$1"
      shift
      ;;
    --cli)
      MODE="cli"
      shift
      ;;
    --gui)
      MODE="gui"
      shift
      ;;
    --auto)
      MODE="auto"
      shift
      ;;
    --headless)
      HEADLESS=1
      shift
      ;;
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    --yes|--non-interactive)
      AUTO_APPROVE=1
      shift
      ;;
    --simulate-gui-step)
      SIMULATE_GUI_STEP=1
      shift
      ;;
    --no-start-after-init)
      NO_START_AFTER_INIT=1
      shift
      ;;
    --workspace-root)
      WORKSPACE_ROOT_ARG="${2:-}"
      shift 2
      ;;
    --components)
      INSTALL_COMPONENTS_ARG="${2:-}"
      shift 2
      ;;
    --skip-node-install)
      SKIP_NODE_INSTALL=1
      shift
      ;;
    --skip-python-install)
      SKIP_PYTHON_INSTALL=1
      shift
      ;;
    --install-plugin-python-deps)
      INSTALL_PLUGIN_PYTHON_DEPS=1
      shift
      ;;
    --strict-dependencies)
      STRICT_DEPENDENCIES=1
      shift
      ;;
    --overwrite-config)
      FORCE_CONFIG_REWRITE=1
      shift
      ;;
    --start-after-install)
      START_AFTER_INSTALL=1
      shift
      ;;
    --vcp-api-url)
      VCP_API_URL_ARG="${2:-}"
      shift 2
      ;;
    --vcp-api-key)
      VCP_API_KEY_ARG="${2:-}"
      shift 2
      ;;
    --vcp-port)
      VCP_PORT_ARG="${2:-}"
      shift 2
      ;;
    --vcp-key)
      VCP_KEY_ARG="${2:-}"
      shift 2
      ;;
    --admin-user)
      ADMIN_USER_ARG="${2:-}"
      shift 2
      ;;
    --admin-password)
      ADMIN_PASSWORD_ARG="${2:-}"
      shift 2
      ;;
    --chat-server-url)
      CHAT_SERVER_URL_ARG="${2:-}"
      shift 2
      ;;
    --chat-api-key)
      CHAT_API_KEY_ARG="${2:-}"
      shift 2
      ;;
    --chat-log-url)
      CHAT_LOG_URL_ARG="${2:-}"
      shift 2
      ;;
    --chat-log-key)
      CHAT_LOG_KEY_ARG="${2:-}"
      shift 2
      ;;
    --backend-cwd)
      BACKEND_CWD_ARG="${2:-}"
      shift 2
      ;;
    --backend-cmd)
      BACKEND_CMD_ARG="${2:-}"
      shift 2
      ;;
    --chat-cwd)
      CHAT_CWD_ARG="${2:-}"
      shift 2
      ;;
    --chat-cmd)
      CHAT_CMD_ARG="${2:-}"
      shift 2
      ;;
    --startup-delay)
      STARTUP_DELAY="${2:-}"
      shift 2
      ;;
    --version)
      echo "${VERSION}"
      exit 0
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

if [ "${HEADLESS}" -eq 1 ] && [ "${MODE}" = "gui" ]; then
  echo "Invalid arguments: --headless cannot be combined with --gui" >&2
  exit 2
fi

if [ "${MODE}" = "auto" ]; then
  if [ "${HEADLESS}" -eq 1 ]; then
    MODE="cli"
  elif [ -n "${DISPLAY:-}" ]; then
    MODE="gui"
  else
    MODE="cli"
  fi
fi

if [ "${HEADLESS}" -eq 1 ]; then
  MODE="cli"
fi

validate_vcp_port

if [ "${COMMAND}" = "auto" ]; then
  if [ "${DRY_RUN}" -eq 1 ] || [ "${SIMULATE_GUI_STEP}" -eq 1 ]; then
    COMMAND="install"
  elif [ -f "${CONFIG_FILE}" ]; then
    COMMAND="start"
  else
    COMMAND="init"
  fi
fi

if [ "${COMMAND}" = "resume" ]; then
  latest_session="$(ls -1t "${STATE_DIR}"/session-*.json 2>/dev/null | head -n 1 || true)"
  if [ -z "${latest_session}" ]; then
    echo "No previous session found in ${STATE_DIR}" >&2
    exit 3
  fi
  SESSION_FILE="${latest_session}"
  SESSION_ID="$(basename "${SESSION_FILE}" .json)"
  SESSION_ID="${SESSION_ID#session-}"
  log INFO "Resuming session ${SESSION_ID}"
else
  SESSION_ID="${VCP_INSTALLER_SESSION_ID:-$(date -u +%Y%m%dT%H%M%SZ)}"
  SESSION_FILE="${STATE_DIR}/session-${SESSION_ID}.json"
  log INFO "Starting new session ${SESSION_ID}"
fi

if [ "${AUTO_APPROVE}" -eq 1 ]; then
  log INFO "Non-interactive mode enabled."
fi

log INFO "Mode: ${MODE} (headless=${HEADLESS}, dry_run=${DRY_RUN}, command=${COMMAND})"

case "${COMMAND}" in
  install|resume)
    run_install_flow "${SESSION_FILE}"
    ;;
  init)
    run_init
    if [ "${NO_START_AFTER_INIT}" -eq 0 ]; then
      run_start_stack
    fi
    ;;
  start)
    run_start_stack
    ;;
  stop)
    run_stop_stack
    ;;
  status)
    run_status
    ;;
  reset)
    run_reset
    ;;
  *)
    echo "Unsupported command: ${COMMAND}" >&2
    exit 2
    ;;
esac
